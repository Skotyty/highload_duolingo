# highload_duolingo
Работа в рамках предмета "Проектирование высоконагруженных приложений" программы "Веб-разработка" образовательного центра VK в МГТУ им. Баумана

## 1. Тема и целевая аудитория

### Целевая аудитория:
- **Размер аудитории**: По данным за второй квартал 2024 года MAU ~103.6M[^1].
- **Местоположение**: Глобальная аудитория (США, Европа, Азия).

##  Ключевой функционал MVP

Основные функции приложения:

1. **Регистрация и авторизация пользователей**
   
2. **Выбор языка и уровня владения**
  
3. **Уроки и упражнения**
   - Проведение уроков с различными видами упражнений (выбор правильного ответа, перевод, составление предложений).

4. **Прогресс и награды**
   - Отслеживание прогресса пользователя по урокам.
   - Система награждений: очки, уровни и виртуальная валюта за успешное выполнение уроков.

5. **Push-уведомления**
   - Напоминания о необходимости продолжать занятия.

6. **Сохранение данных на сервере**

7. **Система лидербордов**
   - Возможность соревноваться с другими пользователями в таблице лидеров.

##  Продуктовые решения

1. **Хранение уроков на сервере**
   
2. **Сохранение прогресса на сервере**

3. **Геймификация обучения**

## 2. Расчет нагрузки

### Продуктовые метрики

#### Месячная и дневная аудитория

| **Метрика**                  | **Значение**                 | **Источник**                           |
|------------------------------|------------------------------|----------------------------------------|
| **MAU (Monthly Active Users)**| 103.6М пользователей     | Duolingo Q2 2024 Shareholder Letter[^1] |
| **DAU (Daily Active Users)**  | 34.1М пользователей     | Duolingo Q2 2024 Shareholder Letter[^1] |

#### Средний размер хранения на пользователя

#### 1. Аккаунт пользователя (~100 байт)

- **Email**:  
    Средняя длина email-адреса — 30 символов[^2].
    **Размер**: 30 байт.

- **Хеш пароля**:  
    Размер хеша SHA-256 составляет 256 бит (32 байта).  
    **Размер**: 32 байта.

- **Дата регистрации**:  
  - Дата регистрации сохраняется в формате UNIX timestamp (целое число).  
    Для этого используется 8 байт.  
    **Размер**: 8 байт.

**Итого для аккаунта**:  
30 байт + 32 байта + 8 байт = **70 байт**.  
С учетом накладных расходов округляем до **~100 байт**.

#### 2. Профиль пользователя (~350 байт)

- **Имя пользователя**:  
  - Будем считать, что средняя длина ника — 10 символов.  
    **Размер**: 10 байт.

- **Аватар**:  
    **Размер**: 100 байт.

- **Настройки**:  
  - Пользовательские настройки, такие как предпочтения уведомлений и язык интерфейса, занимают около 200 байт.  
    **Размер**: 200 байт.

**Итого для профиля**:  
20 байт + 100 байт + 200 байт **320 байт**.  
Округлено до **~350 байт**.

#### 3. Прогресс обучения (~50 КБ)

- **Набранные очки**:  
  - Для хранения общего количества очков требуется 4 байта (целое число).  
    **Размер**: 4 байта.

- **Достижения**:  
  - Будем считать, что у пользователя в среднем будет до 50 достижений. Каждое достижение занимает около 100 байт (ID, статус выполнения).  
    50 достижений * 100 байт = **5 000 байт** (5 КБ).

**Итого для прогресса**:  
4 байта + 5 000 байт = **5 004 байта**.  
Округлено до **~50 КБ**.

#### 4. Социальные взаимодействия (~1 КБ)

- **Друзья**:  
  - Будем считать, что у пользователя в среднем будет до 15 друзей. Для хранения каждого друга требуется около 40 байт (ID, статус).  
    15 друзей * 40 байт = ** 600 байт**.

- **Позиции в лидербордах**:  
     **Размер**: **144 байт.**

 **ID лидерборда**:
   - Каждый лидерборд имеет уникальный идентификатор. Если используется UUID (универсальный уникальный идентификатор), это займет **16 байт**.
   
 **Позиция пользователя**:
   - Позиция пользователя в таблице (например, 1-е место, 100-е место) хранится в виде целого числа (integer). Для этого требуется **4 байта**.

 **Количество набранных очков**:
   - Integer занимает **4 байта**.

**Дополнительные данные (Имя и аватар пользователя)**:
   -  20 байт для имени и 100 байт для URL аватара. **120 байт**

**Итого для социальных взаимодействий**:  
 600 байт + 144 байт  = **744 байт**.  
Округлено до **~1 КБ**.

---           

### Общий итог

| **Категория данных**        | **Размер данных**        | **Комментарий**                                                    |
|-----------------------------|--------------------------|--------------------------------------------------------------------|
| **Аккаунт пользователя**     | ~100 байт                | Email, хеш пароля, дата регистрации                                |
| **Профиль пользователя**     | ~350 байт                | Имя пользователя, ссылка на аватар, настройки                      |
| **Прогресс обучения**        | ~50 КБ                   | Пройденные уроки, набранные очки, достижения                       |
| **Социальные взаимодействия**| ~1 КБ                    | Друзья, позиции в лидербордах                                      |
| **Общий объем данных**       | **~52 КБ**               | Общий объем данных на одного пользователя                          |

#### Среднее количество действий пользователя по типам в день

| **Тип действия**             | **Количество в день на пользователя** | **Всего в день**                      |
|------------------------------|---------------------------------------|---------------------------------------|
| Вход в приложение             | 1                                     | 34.1М                                 |
| Загрузка домашнего экрана     | 1                                     | 34.1М                                 |
| Начало урока                  | 2                                     | 68.2М                                 |
| Загрузка упражнения           | 40                                    | 1364М                                 |
| Отправка ответа               | 40                                    | 1364М                                 |
| Обновление прогресса          | 2                                     | 68.2М                                 |
| Просмотр лидерборда           | 1                                     | 34.1М                                 |
| Получение наград              | 1                                     | 34.1М                                 |
| **Итого**                     | **88 действий**                       | **~3000M действий в день**            |

---

### Технические метрики

#### Уроки

- Уроки обычно содержат 14-20 вопросов.
- Примерно треть вопросов — аудиовопросы.
- Средний объем текстового контента одного вопроса составляет около 50 байт.
- Средний объем аудиовопроса — около 160 КБ.

**Общая оценка размера урока**:
- **Текстовые вопросы**: 9–13 вопросов по 50 байт.  
  **Итого**: 450–650 байт (округлим до 0.5–0.7 КБ).
- **Аудиовопросы**: 5–7 вопросов по 160 КБ.  
  **Итого**: 800–1120 КБ (округлим до 0.8–1.1 МБ).

**Общий размер одного урока**: **0.8–1.1 МБ**.

Каждый пользователь Duolingo находится в лиге (таблице лидеров), где соревнуется с 29 другими пользователями. Для хранения данных о пользователе в лиге требуется сохранить несколько параметров.
теле в лиге. Для одного пользователя в лиге требуется **144 байта** на одного пользователя. Каждая таблица лидеров (лига) в Duolingo состоит из 30 пользователей. Для хранения данных о 30 пользователях требуется:
- 30 пользователей * 144 байта = **4 320 байт** = **4,32 КБ** на одну таблицу лидеров.

#### Размер хранения в разбивке по типам данных

| **Тип данных**         | **Количество записей**              | **Размер одной записи** | **Общий объем данных** |
|------------------------|-------------------------------------|-------------------------|------------------------|
| Пользователи           | 103 600 000                         | 52 КБ                   | ~5,1 ТБ                |
| Логи входа(на 30 дней) | 34 100 000 в день                   | 0,5 КБ                  | ~17 ГБ (в день) × 30 дней = ~510 ГБ|
| Таблицы лидеров (лиги) | 3 453 333 таблицы(MAU/30 человек в одной лиге)| ~4,32 КБ на таблицу    | ~14,9 ГБ               |
| **Итого**              |                                      |                         | **~5,7 ТБ** |

#### Сетевой трафик

- **Средний размер запроса**: 0,5 КБ
- **Средний размер ответа**: 3 КБ
- **Количество запросов в день**: 3 000 000 000
- **Входящий**: 3 000 000 000 запросов * 0,5 КБ = **1,5 ТБ**
- **Исходящий**: 3 000 000 000 ответов * 3 КБ = **9 ТБ**

#### Пиковое потребление

**Предположения**:
- Пиковая нагрузка приходится на 3 часа в день.
- В пиковые часы совершается 50% дневных действий (1 500 000 000 действий за 3 часа).

**RPS в пиковые часы**:  
1 500 000 000 / (3 * 3600) ≈ **138 888 RPS**

**Пиковый сетевой трафик**:

- **Входящий**: 138 888 RPS * 0,5 КБ ≈ **69,4 Гбит/с**
- **Исходящий**: 138 888 RPS * 3 КБ ≈ **416,6 Гбит/с**

#### RPS по типам запросов

| **Тип запроса**            | **Всего запросов в день** | **Средний RPS** | **Пиковый RPS** |
|----------------------------|---------------------------|-----------------|-----------------|
| Авторизация                | 34 100 000                | 394             | 788             |
| Загрузка домашнего экрана  | 34 100 000                | 394             | 788             |
| Начало урока               | 68 200 000                | 788             | 1 576           |
| Загрузка упражнения        | 1 364 000 000             | 15 787          | 31 574          |
| Отправка ответа            | 1 364 000 000             | 15 787          | 31 574          |
| Обновление прогресса       | 68 200 000                | 788             | 1 576           |
| Просмотр лидерборда        | 34 100 000                | 394             | 788             |
| Получение наград           | 34 100 000                | 394             | 788             |
| **Итого**                  | **3 000 000 000**         | **35 720**      | **71 252**      |

## 3. Глобальная балансировка нагрузки

### Функциональное разбиение по доменам

1. **www.duolingo.com**  
   Основной веб-сайт для доступа к обучающим материалам, профилям пользователей и общей информации.

2. **api.duolingo.com**  
   RESTful API для мобильных приложений и сторонних интеграций. Обрабатывает основные запросы приложения: уроки, прогресс, профили и т.д.

3. **auth.duolingo.com**  
   Сервис аутентификации и авторизации пользователей.

4. **events.duolingo.com**  
   Сбор и обработка событий для аналитики и логирования пользовательской активности.

5. **notifications.duolingo.com**  
   Сервис отправки push-уведомлений и email-рассылок.

### Обоснование расположения дата-центров

Для обеспечения низкой задержки и высокой доступности пользователям по всему миру необходимо стратегически расположить дата-центры (ДЦ).

**Распределение пользователей по регионам**:

| **Регион**          | **Доля пользователей** |
|---------------------|------------------------|
| Северная Америка     | 30%                    |
| Европа              | 25%                    |
| Азия                | 25%                    |
| Южная Америка       | 15%                    |
| Остальные регионы   | 5%                     |

Основано на информации, что США генерируют самый высокий денежный трафик в приложении (~30%)[^1]

**Выбор локаций ДЦ**:

1. **Северная Америка**:
   - **Вирджиния, США** (Восток)
   - **Орегон, США** (Запад)

2. **Европа**:
   - **Франкфурт, Германия**
   - **Лондон, Великобритания**

3. **Азия**:
   - **Сингапур**
   - **Токио, Япония**

4. **Южная Америка**:
   - **Сан-Паулу, Бразилия**

**Обоснование выбора**:
- **Близость к пользователям**: ДЦ расположены в регионах с наибольшей концентрацией пользователей.
- **Инфраструктура**: Локации с развитой IT-инфраструктурой.[^3] [^4] [^5]

### Расчет распределения запросов по ДЦ

Исходя из распределения пользователей и ранее рассчитанных метрик, распределим нагрузку по ДЦ.

**Общий DAU**: 34,1 млн пользователей.

**Распределение пользователей по регионам**:

- **Северная Америка (30%)**: 10,23 млн
- **Европа (25%)**: 8,525 млн
- **Азия (25%)**: 8,525 млн
- **Южная Америка (15%)**: 5,115 млн
- **Остальные регионы (5%)**: 1,705 млн

**Количество действий в день по регионам**:

- **Среднее количество действий на пользователя**: 88 действий.

- **Северная Америка**: 10,23 млн * 88 ≈ 900 млн действий
- **Европа**: 8,525 млн * 88 ≈ 750 млн действий
- **Азия**: 8,525 млн * 88 ≈ 750 млн действий
- **Южная Америка**: 5,115 млн * 88 ≈ 450 млн действий
- **Остальные регионы**: 1,705 млн * 88 ≈ 150 млн действий

**Средний и пиковый RPS по регионам**:

- **Средний RPS**: Действия / 86 400 секунд
- **Пиковый RPS**: Средний RPS * 2 

| **Регион**            | **Средний RPS** | **Пиковый RPS** |
|-----------------------|-----------------|-----------------|
| Северная Америка      | 10 416          | 20 832          |
| Европа                | 8 681           | 17 362          |
| Азия                  | 8 681           | 17 362          |
| Южная Америка         | 5 208           | 10 416          |
| Остальные регионы     | 1 736           | 3 472           |

### Схема DNS-балансировки

Для глобальной балансировки нагрузки будем использовать **Latency-based DNS**. 
Это обеспечит минимальную задержку и динамическую адаптацию. 

## 4. Локальная балансировка нагрузки

Будем использовать L7-балансировку(NGINX) в сочетании с k8s

### Архитектура

Клиент → Latency-based DNS → NGINX(Round-robin) → Kubernetes

### Элементы:
- **NGINX как L7-балансировщик**: NGINX распределяет входящие запросы между микросервисами, 
выступает в роли обратного прокси-сервера и выполняет SSL-терминацию для уменьшения нагрузки на серверы. 
Он также может кешировать часто запрашиваемые данные, такие как ресурсы уроков, что улучшает производительность.
- **Kubernetes**: Обеспечивает оркестрацию и управление контейнеризованными сервисами,
   гарантируя отказоустойчивость и возможность масштабирования в зависимости от нагрузки.

## Мониторинг и логирование

- **Prometheus** и **Grafana** для сбора метрик и визуализации состояния системы в реальном времени,
  что позволяет оперативно реагировать на изменения в нагрузке и обнаруживать сбои.


##  Источники

[^1]: [Duolingo Q2 2023 Shareholder Letter](https://investors.duolingo.com/static-files/fa65f0d4-0c4e-42e9-a8a3-378de14f2d4d)
[^2]: (https://sky.pro/wiki/sql/opredelenie-optimalnoy-dliny-poley-email-v-sql-rekomendatsii/)
[^3]: (https://datacentremagazine.com/articles/top-10-global-data-centre-markets)
[^4]:(https://www.datacenterdynamics.com/en/news/equinix-launches-hyperscale-data-center-in-tokyo-japan/)
[^5]:(https://www.datacenters.com/locations/brazil/state-of-sao-paulo)
---

